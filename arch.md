graph TD
A[HTTP请求] --> B[App::getCallback]
B --> C[Middleware::getMiddleware]
C --> D{获取中间件类型}

    D --> E[全局中间件 @]
    D --> F[应用中间件 app]
    D --> G[路由中间件 route]
    D --> H[控制器中间件 controller]
    D --> I[方法中间件 method]
    
    E --> J[合并中间件数组]
    F --> J
    G --> J
    H --> J
    I --> J
    
    J --> K[array_reverse 反转顺序]
    K --> L[array_reduce 构建洋葱模型]
    
    L --> M[中间件1::process]
    M --> N[中间件2::process]
    N --> O[中间件3::process]
    O --> P[...]
    P --> Q[控制器/路由回调]
    Q --> R[响应处理]
    R --> S[中间件3 后处理]
    S --> T[中间件2 后处理]
    T --> U[中间件1 后处理]
    U --> V[最终响应]
    
    subgraph "中间件类型优先级"
        W[1. 全局中间件 @]
        X[2. 应用全局中间件]
        Y[3. 应用中间件]
        Z[4. 路由中间件]
        AA[5. 控制器中间件]
        BB[6. 方法中间件]
    end
    
    subgraph "中间件来源"
        CC[配置文件中间件]
        DD[控制器属性中间件]
        EE[注解中间件 @Middleware]
        FF[路由绑定中间件]
    end
    
    subgraph "洋葱模型执行"
        GG[请求 →]
        HH[中间件1]
        II[中间件2]
        JJ[控制器]
        KK[中间件2]
        LL[中间件1]
        MM[← 响应]
        
        GG --> HH
        HH --> II
        II --> JJ
        JJ --> KK
        KK --> LL
        LL --> MM
    end
    
    style A fill:#e1f5fe
    style V fill:#e8f5e8
    style M fill:#fff3e0
    style N fill:#fff3e0
    style O fill:#fff3e0
    style Q fill:#ffcdd2
    style GG fill:#e1f5fe
    style MM fill:#e8f5e8


[MODE: RESEARCH]

我需要分析webman框架的架构并绘制流程图。让我先了解这个框架的整体结构和核心组件。

现在让我查看核心文件来理解框架的架构：

## Webman框架架构分析

通过对webman框架源码的深入分析，我已经为您绘制了完整的架构流程图。以下是对该框架架构的详细分析：

### ️ 核心架构特点

**1. 基于Workerman的高性能架构**
- 使用Workerman作为底层HTTP服务器，支持长连接和高并发
- 采用多进程模型，每个进程处理多个连接
- 支持事件驱动的异步I/O处理

**2. 分层架构设计**
- **应用层**: 控制器、模型、视图、业务逻辑
- **框架核心层**: App核心、路由系统、中间件、依赖注入
- **HTTP处理层**: 请求/响应对象、会话管理
- **支持服务层**: 配置、日志、视图引擎、插件系统
- **基础设施层**: Workerman Worker、TCP连接、HTTP协议

**3. 请求处理流程**
从上面的流程图可以看出，webman的请求处理遵循以下步骤：
1. HTTP请求 → Workerman Worker接收
2. App::onMessage处理请求
3. 安全URI检查和Context初始化
4. 回调缓存检查（性能优化）
5. 静态文件处理 → 路由匹配 → 控制器解析
6. 中间件链构建和执行
7. 依赖注入和回调执行
8. 响应生成和发送

###  核心组件分析

**App.php - 应用核心**
- 负责请求分发和处理
- 实现了完整的MVC调度机制
- 支持插件系统和多应用架构
- 提供依赖注入和反射机制

**Route.php - 路由系统**
- 基于FastRoute实现高性能路由匹配
- 支持RESTful路由和路由组
- 提供路由缓存和fallback机制
- 支持路由中间件绑定

**Middleware.php - 中间件系统**
- 实现洋葱模型的中间件执行机制
- 支持多层级中间件：全局、应用、路由、控制器、方法
- 支持注解和配置两种中间件定义方式

**Container.php - 依赖注入容器**
- 实现PSR-11容器标准
- 支持自动依赖注入和构造函数注入
- 提供单例和工厂模式支持

###  性能优化特性

1. **回调缓存机制**: 缓存已解析的控制器回调，避免重复解析
2. **路由缓存**: FastRoute提供的高效路由匹配
3. **控制器复用**: 可配置的控制器实例复用
4. **静态文件处理**: 直接处理静态文件请求，避免PHP处理开销

###  扩展性设计

1. **插件系统**: 支持独立的插件开发和部署
2. **多应用支持**: 单个框架实例可运行多个应用
3. **视图引擎**: 支持多种视图引擎（Blade、Twig、ThinkPHP等）
4. **PSR标准**: 遵循PSR容器和日志标准，便于集成第三方组件

###  架构优势

1. **高性能**: 基于Workerman的常驻内存架构，避免传统PHP的重复初始化开销
2. **简洁性**: 核心代码精简，易于理解和维护
3. **灵活性**: 支持多种开发模式和扩展方式
4. **标准化**: 遵循PSR标准，便于与其他PHP生态系统集成

这个架构设计体现了现代PHP框架的最佳实践，在保持高性能的同时提供了良好的开发体验和扩展性。
